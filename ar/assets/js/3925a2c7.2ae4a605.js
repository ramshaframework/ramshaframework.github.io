"use strict";(globalThis.webpackChunkramsha_doc=globalThis.webpackChunkramsha_doc||[]).push([[2643],{1234:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"basics/infrastructure/unit-of-work","title":"Unit of Work","description":"Overview","source":"@site/docs/basics/infrastructure/unit-of-work.md","sourceDirName":"basics/infrastructure","slug":"/basics/infrastructure/unit-of-work","permalink":"/ar/docs/basics/infrastructure/unit-of-work","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/basics/infrastructure/unit-of-work.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Global Query Filters","permalink":"/ar/docs/basics/infrastructure/entity-framework-core/global-data-filters"},"next":{"title":"Settings","permalink":"/ar/docs/basics/settings"}}');var s=r(4848),t=r(8453);const a={sidebar_position:2},o="Unit of Work",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Key Concepts",id:"key-concepts",level:2},{value:"Automatic Unit of Work per Request",id:"automatic-unit-of-work-per-request",level:2},{value:"Using Unit of Work in Controllers (Clear Examples)",id:"using-unit-of-work-in-controllers-clear-examples",level:2},{value:"Example: Non-Transactional Unit of Work in Controller",id:"example-non-transactional-unit-of-work-in-controller",level:3},{value:"Example: Transactional Unit of Work in Controller",id:"example-transactional-unit-of-work-in-controller",level:3},{value:"Using Unit of Work in Application Services (Clear Examples)",id:"using-unit-of-work-in-application-services-clear-examples",level:2},{value:"Example: Non-Transactional Unit of Work in Application Service",id:"example-non-transactional-unit-of-work-in-application-service",level:3},{value:"Example: Transactional Unit of Work in Application Service",id:"example-transactional-unit-of-work-in-application-service",level:3},{value:"Using Unit of Work in Repositories",id:"using-unit-of-work-in-repositories",level:2},{value:"Example Repository Method",id:"example-repository-method",level:3},{value:"Transactional vs Non-Transactional Summary",id:"transactional-vs-non-transactional-summary",level:2},{value:"Injecting IUnitOfWorkManager Directly",id:"injecting-iunitofworkmanager-directly",level:2},{value:"Summary",id:"summary",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(n){const e={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"unit-of-work",children:"Unit of Work"})}),"\n",(0,s.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(e.p,{children:["Ramsha Framework provides a ",(0,s.jsx)(e.strong,{children:"robust Unit of Work (UoW) system"})," inspired by ABP\u2019s Unit of Work concept, but with a ",(0,s.jsx)(e.strong,{children:"different execution model"}),"."]}),"\n",(0,s.jsxs)(e.p,{children:["Unlike ABP, ",(0,s.jsx)(e.strong,{children:"Ramsha does not rely on dynamic proxies or attributes"})," to manage Unit of Work boundaries.",(0,s.jsx)(e.br,{}),"\n","Instead, Ramsha uses ",(0,s.jsx)(e.strong,{children:"explicit, method-based Unit of Work control"})," that is:"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Clear and predictable"}),"\n",(0,s.jsx)(e.li,{children:"Easy to debug"}),"\n",(0,s.jsx)(e.li,{children:"Fully integrated with Controllers, Application Services, and Repositories"}),"\n",(0,s.jsx)(e.li,{children:"Automatically applied at the HTTP request level"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["A ",(0,s.jsx)(e.strong,{children:"Unit of Work"})," represents a single logical operation"]}),"\n",(0,s.jsxs)(e.li,{children:["All database operations inside a UoW share:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"The same DbContext"}),"\n",(0,s.jsx)(e.li,{children:"The same transaction (if enabled)"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["A Unit of Work can be:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.strong,{children:"Transactional"})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.strong,{children:"Non-transactional"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["Unit of Work instances can be ",(0,s.jsx)(e.strong,{children:"nested"})]}),"\n",(0,s.jsxs)(e.li,{children:["Only the ",(0,s.jsx)(e.strong,{children:"outermost Unit of Work"})," commits or rolls back"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"automatic-unit-of-work-per-request",children:"Automatic Unit of Work per Request"}),"\n",(0,s.jsxs)(e.p,{children:["Ramsha provides a ",(0,s.jsx)(e.strong,{children:"Unit of Work middleware"})," that automatically creates a reserved Unit of Work for each HTTP request."]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public class UnitOfWorkMiddleware\r\n{\r\n    public async Task InvokeAsync(HttpContext context)\r\n    {\r\n        using (var uow = unitOfWorkManager.Reserve(\r\n            RamshaUnitOfWorkReservationNames.ActionUnitOfWorkReservationName))\r\n        {\r\n            await next(context);\r\n            await uow.CompleteAsync();\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"This means:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Every HTTP request already runs inside a Unit of Work"}),"\n",(0,s.jsx)(e.li,{children:"Controllers, services, and repositories reuse the same UoW"}),"\n",(0,s.jsx)(e.li,{children:"Manual transaction handling is usually unnecessary"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"using-unit-of-work-in-controllers-clear-examples",children:"Using Unit of Work in Controllers (Clear Examples)"}),"\n",(0,s.jsx)(e.p,{children:"All API controllers inherit from:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"RamshaControllerBase\n"})}),"\n",(0,s.jsx)(e.h3,{id:"example-non-transactional-unit-of-work-in-controller",children:"Example: Non-Transactional Unit of Work in Controller"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public class ProductController(IProductRepository productRepository)\r\n : RamshaApiController\r\n{\r\n    [HttpPost]\r\n    public async Task<RamshaResult<string>> Create(CreateProductDto input)\r\n    {\r\n       return await UnitOfWork(async () =>\r\n        {\r\n            var product = new Product(input.Name, input.Price);\r\n            await productRepository.AddAsync(product);\r\n            return product.Id.ToString();\r\n        });\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"What happens here:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"The request already has a reserved Unit of Work"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"UnitOfWork(...)"})," reuses it"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"SaveChanges"})," is called automatically"]}),"\n",(0,s.jsx)(e.li,{children:"No explicit transaction is created"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h3,{id:"example-transactional-unit-of-work-in-controller",children:"Example: Transactional Unit of Work in Controller"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:'[HttpPost("order")]\r\npublic async Task<RamshaResult> CreateOrder(CreateOrderDto input)\r\n{\r\n   return await TransactionalUnitOfWork(async () =>\r\n    {\r\n        await _orderRepository.AddAsync(new Order(input.CustomerId));\r\n        await _inventoryRepository.DecreaseStockAsync(input.ProductId);\r\n        return RamshaResult.Ok();\r\n    });\r\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Use transactional UoW when:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Multiple writes must succeed together"}),"\n",(0,s.jsx)(e.li,{children:"Business consistency is critical"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"using-unit-of-work-in-application-services-clear-examples",children:"Using Unit of Work in Application Services (Clear Examples)"}),"\n",(0,s.jsx)(e.p,{children:"All application services inherit from:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"RamshaService\n"})}),"\n",(0,s.jsx)(e.h3,{id:"example-non-transactional-unit-of-work-in-application-service",children:"Example: Non-Transactional Unit of Work in Application Service"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public class ProductAppService(IProductRepository productRepository)\r\n : RamshaService\r\n{\r\n    public async Task CreateAsync(CreateProductDto input)\r\n    {\r\n        await UnitOfWork(async () =>\r\n        {\r\n            var product = new Product(input.Name, input.Price);\r\n            await _productRepository.AddAsync(product);\r\n        });\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h3,{id:"example-transactional-unit-of-work-in-application-service",children:"Example: Transactional Unit of Work in Application Service"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public class OrderAppService(\r\n        IOrderRepository orderRepository,\r\n        IInventoryRepository inventoryRepository) : RamshaService\r\n{\r\n    public async Task<RamshaResult> PlaceOrderAsync(PlaceOrderDto input)\r\n    {\r\n       return await TransactionalUnitOfWork(async () =>\r\n        {\r\n            await orderRepository.AddAsync(new Order(input.CustomerId));\r\n            await inventoryRepository.DecreaseStockAsync(input.ProductId);\r\n            return RamshaResult.Ok();\r\n        });\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Key points:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Controllers and Application Services behave identically"}),"\n",(0,s.jsx)(e.li,{children:"Unit of Work logic stays explicit and readable"}),"\n",(0,s.jsx)(e.li,{children:"No attributes or magic interception"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"using-unit-of-work-in-repositories",children:"Using Unit of Work in Repositories"}),"\n",(0,s.jsx)(e.p,{children:"Ramsha repositories automatically integrate with Unit of Work."}),"\n",(0,s.jsx)(e.p,{children:"Base repository:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"EFCoreRepository<TDbContext, TEntity>\n"})}),"\n",(0,s.jsx)(e.h3,{id:"example-repository-method",children:"Example Repository Method"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public async Task<TEntity> AddAsync(TEntity entity)\r\n{\r\n    return await UnitOfWork(async () =>\r\n    {\r\n        var context = await GetDbContextAsync();\r\n        var entry = await context.Set<TEntity>().AddAsync(entity);\r\n        return entry.Entity;\r\n    });\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Behavior:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Reuses existing Unit of Work if present"}),"\n",(0,s.jsx)(e.li,{children:"Does not commit independently"}),"\n",(0,s.jsx)(e.li,{children:"SaveChanges is coordinated by the outer UoW"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"transactional-vs-non-transactional-summary",children:"Transactional vs Non-Transactional Summary"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"Type"}),(0,s.jsx)(e.th,{children:"When to Use"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Non-Transactional"}),(0,s.jsx)(e.td,{children:"Simple CRUD, reads, performance paths"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"Transactional"}),(0,s.jsx)(e.td,{children:"Multi-step writes, consistency-critical logic"})]})]})]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"injecting-iunitofworkmanager-directly",children:"Injecting IUnitOfWorkManager Directly"}),"\n",(0,s.jsx)(e.p,{children:"In advanced scenarios, you can inject and control the Unit of Work manually."}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-csharp",children:"public class BackgroundJob\r\n{\r\n    private readonly IUnitOfWorkManager _unitOfWorkManager;\r\n\r\n    public BackgroundJob(IUnitOfWorkManager unitOfWorkManager)\r\n    {\r\n        _unitOfWorkManager = unitOfWorkManager;\r\n    }\r\n\r\n    public async Task ExecuteAsync()\r\n    {\r\n        using var uow = _unitOfWorkManager.Begin(\r\n            new UnitOfWorkOptions { IsTransactional = true });\r\n\r\n        // database operations\r\n\r\n        await uow.CompleteAsync();\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"Use this approach for:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Background jobs"}),"\n",(0,s.jsx)(e.li,{children:"Console apps"}),"\n",(0,s.jsx)(e.li,{children:"Integration scenarios"}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(e.p,{children:"Ramsha Unit of Work system:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["Uses ",(0,s.jsx)(e.strong,{children:"explicit method-based control"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Avoids attributes and proxies"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Automatically scopes one UoW per request"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Works consistently across:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Controllers"}),"\n",(0,s.jsx)(e.li,{children:"Application Services"}),"\n",(0,s.jsx)(e.li,{children:"Repositories"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"Supports transactional and non-transactional flows"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"This design ensures clarity, safety, and clean architecture alignment."}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.strong,{children:(0,s.jsx)(e.a,{href:"../settings",children:"Settings"})})}),"\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.strong,{children:(0,s.jsx)(e.a,{href:"../authorization",children:"Authorization"})})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},8453:(n,e,r)=>{r.d(e,{R:()=>a,x:()=>o});var i=r(6540);const s={},t=i.createContext(s);function a(n){const e=i.useContext(t);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:a(n.components),i.createElement(t.Provider,{value:e},n.children)}}}]);