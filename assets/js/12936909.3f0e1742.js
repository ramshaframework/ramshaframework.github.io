"use strict";(globalThis.webpackChunkramsha_doc=globalThis.webpackChunkramsha_doc||[]).push([[7392],{6515:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"basics/infrastructure/entity-framework-core/ef-core-migrations","title":"Database Migrations","description":"Entity Framework Core includes a powerful migration system. Ramsha builds on this foundation to provide a consistent, streamlined way to manage database changes during application development.","source":"@site/docs/basics/infrastructure/entity-framework-core/ef-core-migrations.md","sourceDirName":"basics/infrastructure/entity-framework-core","slug":"/basics/infrastructure/entity-framework-core/ef-core-migrations","permalink":"/docs/basics/infrastructure/entity-framework-core/ef-core-migrations","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/basics/infrastructure/entity-framework-core/ef-core-migrations.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Connections Strings","permalink":"/docs/basics/infrastructure/entity-framework-core/connections-strings"},"next":{"title":"Repositories","permalink":"/docs/basics/infrastructure/entity-framework-core/repositories"}}');var r=i(4848),s=i(8453);const a={sidebar_position:3},o="Database Migrations",c={},l=[{value:"RamshaDesignTimeDbContextFactory Class",id:"ramshadesigntimedbcontextfactory-class",level:2},{value:"Overview",id:"overview",level:2},{value:"Creating Migrations",id:"creating-migrations",level:2},{value:"How the Design-Time Factory Works",id:"how-the-design-time-factory-works",level:3},{value:"Implementation",id:"implementation",level:3},{value:"1. Create Your Design-Time Factory",id:"1-create-your-design-time-factory",level:4},{value:"2. Install Required Package",id:"2-install-required-package",level:4},{value:"3. Migration Commands",id:"3-migration-commands",level:4},{value:"Applying Migrations",id:"applying-migrations",level:2},{value:"1. EF Core Tools Migration Application (Manual)",id:"1-ef-core-tools-migration-application-manual",level:3},{value:"2. Programmatic Migration Application (Automatic)",id:"2-programmatic-migration-application-automatic",level:3},{value:"Configuration for Migration Creation",id:"configuration-for-migration-creation",level:2},{value:"Migration-Specific Settings",id:"migration-specific-settings",level:3},{value:"Customizing Design-Time Configuration",id:"customizing-design-time-configuration",level:3},{value:"Migration Workflow Summary",id:"migration-workflow-summary",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"database-migrations",children:"Database Migrations"})}),"\n",(0,r.jsx)(n.p,{children:"Entity Framework Core includes a powerful migration system. Ramsha builds on this foundation to provide a consistent, streamlined way to manage database changes during application development."}),"\n",(0,r.jsx)(n.h2,{id:"ramshadesigntimedbcontextfactory-class",children:"RamshaDesignTimeDbContextFactory Class"}),"\n",(0,r.jsxs)(n.p,{children:["The foundation for creating migrations in Ramsha is the ",(0,r.jsx)(n.code,{children:"RamshaDesignTimeDbContextFactory<TModule, TDbContext>"})," abstract class. This class implements the ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.design.idesigntimedbcontextfactory-1?view=efcore-10.0&viewFallbackFrom=efcore-latest",children:(0,r.jsx)(n.code,{children:"IDesignTimeDbContextFactory<TDbContext>"})})," interface and provides the infrastructure needed for EF Core Tools to create migrations in a Ramsha application."]}),"\n",(0,r.jsx)(n.p,{children:"The key responsibilities of this abstract class are:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Initializing the Ramsha application module during design time"}),"\n",(0,r.jsx)(n.li,{children:"Building the service provider with proper configuration"}),"\n",(0,r.jsx)(n.li,{children:"Creating and configuring the DbContext instance for migration generation"}),"\n",(0,r.jsx)(n.li,{children:"Handling environment-specific configuration loading"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"There are two distinct phases in the migration process:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Creating Migrations"})," - Generating migration files from model changes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Applying Migrations"})," - Updating the database with generated migrations"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"creating-migrations",children:"Creating Migrations"}),"\n",(0,r.jsxs)(n.p,{children:["Migrations are always created using ",(0,r.jsx)(n.strong,{children:"EF Core Tools"})," with the Design-Time DbContext Factory pattern. This approach uses Microsoft's ",(0,r.jsx)(n.code,{children:"dotnet ef"})," CLI tools along with a ",(0,r.jsx)(n.strong,{children:"Design-Time DbContext Factory"})," (",(0,r.jsx)(n.code,{children:"IDesignTimeDbContextFactory<TContext>"}),")."]}),"\n",(0,r.jsx)(n.h3,{id:"how-the-design-time-factory-works",children:"How the Design-Time Factory Works"}),"\n",(0,r.jsx)(n.p,{children:"When you create migrations, the following flow occurs:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.strong,{children:["Developer runs ",(0,r.jsx)(n.code,{children:"dotnet ef migrations add"})]})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"EF Core Tools"})," searches for an ",(0,r.jsx)(n.code,{children:"IDesignTimeDbContextFactory<TContext>"})," implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"RamshaDesignTimeDbContext"})," initializes the Ramsha application module"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Module builds services"})," and registers the DbContext"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Factory creates DbContext instance"})," with proper configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"EF Core generates migration files"})," based on model changes"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"implementation",children:"Implementation"}),"\n",(0,r.jsx)(n.h4,{id:"1-create-your-design-time-factory",children:"1. Create Your Design-Time Factory"}),"\n",(0,r.jsxs)(n.p,{children:["This class created by default if u create the project with ",(0,r.jsx)(n.a,{href:"../../architecture-and-templates/ramsha-templates/solution-templates",children:(0,r.jsx)(n.code,{children:"Ramsha Soultions Templates"})}),", If not exist you can create new class:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class AppDbContextDesignTimeFactory \r\n    : RamshaDesignTimeDbContext<AppModule, AppDbContext>\r\n{\r\n    // Default implementation is sufficient for most cases\r\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"2-install-required-package",children:"2. Install Required Package"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet add package Microsoft.EntityFrameworkCore.Tools\n"})}),"\n",(0,r.jsx)(n.h4,{id:"3-migration-commands",children:"3. Migration Commands"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Simple Project Structure:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Add a new migration\r\ndotnet ef migrations add InitialCreate\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Clean Architecture Template:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# From startup layer path\r\ndotnet ef migrations add InitialCreate --project ../MyApp.Persistence/MyApp.Persistence.csproj\r\n\r\n# From persistence layer path  \r\ndotnet ef migrations add InitialCreate --startup-project ../MyApp.Startup/MyApp.Startup.csproj\n"})}),"\n",(0,r.jsx)(n.h2,{id:"applying-migrations",children:"Applying Migrations"}),"\n",(0,r.jsxs)(n.p,{children:["Once migrations are created, you have ",(0,r.jsx)(n.strong,{children:"two approaches"})," to apply them to the database:"]}),"\n",(0,r.jsx)(n.h3,{id:"1-ef-core-tools-migration-application-manual",children:"1. EF Core Tools Migration Application (Manual)"}),"\n",(0,r.jsxs)(n.p,{children:["Apply migrations using the ",(0,r.jsx)(n.code,{children:"dotnet ef"})," CLI tool:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Simple project\r\ndotnet ef database update\r\n\r\n# Clean architecture\r\ndotnet ef database update --project ../MyApp.Persistence/MyApp.Persistence.csproj\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Best for:"})," Development environments, testing, and CI/CD pipelines"]}),"\n",(0,r.jsx)(n.h3,{id:"2-programmatic-migration-application-automatic",children:"2. Programmatic Migration Application (Automatic)"}),"\n",(0,r.jsx)(n.p,{children:"Apply migrations automatically through code during application startup:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class AppModule : RamshaModule\r\n{\r\n    public override async Task OnInitAsync(ApplicationInitializationContext context)\r\n    {\r\n        // Apply pending migrations on application startup\r\n        var dbContext = context.ServiceProvider.GetRequiredService<AppDbContext>();\r\n        await dbContext.Database.MigrateAsync();\r\n    }\r\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Best for:"})," Production deployments, containerized applications, and automatic updates"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration-for-migration-creation",children:"Configuration for Migration Creation"}),"\n",(0,r.jsx)(n.h3,{id:"migration-specific-settings",children:"Migration-Specific Settings"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"appsettings.Migrations.json"})," in your startup project for migration creation:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\r\n  "ConnectionStrings": {\r\n    "Default": "Server=(localdb)\\\\mssqllocaldb;Database=DemoApp;Trusted_Connection=True;MultipleActiveResultSets=true"\r\n  }\r\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"customizing-design-time-configuration",children:"Customizing Design-Time Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'public class AppDbContextDesignTimeFactory \r\n    : RamshaDesignTimeDbContext<AppModule, AppDbContext>\r\n{\r\n    protected override IConfigurationRoot BuildConfiguration()\r\n    {\r\n        var environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") \r\n            ?? "Development";\r\n        \r\n        return new ConfigurationBuilder()\r\n            .SetBasePath(Directory.GetCurrentDirectory())\r\n            .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)\r\n            .AddJsonFile($"appsettings.{environment}.json", optional: true)\r\n            .AddJsonFile($"appsettings.Migrations.json", optional: true)\r\n            .AddEnvironmentVariables()\r\n            .AddUserSecrets<AppDbContextDesignTimeFactory>(optional: true)\r\n            .Build();\r\n    }\r\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"migration-workflow-summary",children:"Migration Workflow Summary"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Development Phase:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Make model changes to your entities"}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"dotnet ef migrations add <Name>"})," to generate migration files"]}),"\n",(0,r.jsx)(n.li,{children:"Review generated migration files"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Application Phase (Choose One):"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Option A:"})," Use ",(0,r.jsx)(n.code,{children:"dotnet ef database update"})," (development/CI)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Option B:"})," Let application apply migrations automatically via ",(0,r.jsx)(n.code,{children:"MigrateAsync()"})," (production)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"./repositories",children:"Repositories"})})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"./global-data-filters",children:"Global Query Filters"})})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var t=i(6540);const r={},s=t.createContext(r);function a(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);